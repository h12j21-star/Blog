---
title: ë‹¤ì´ì–´ë¦¬ ì›¹ì—ì„œ React-queryì‚¬ìš©í•˜ê¸°
date: 2023-08-03
description: í”„ë¡œì íŠ¸ React-query ë„ì…ê¸°
tags:
  - React
  - Project
---

## âœ”ï¸ react-query

ë‹¤ì´ì–´ë¦¬ì— ê¸€ì„ ì‘ì„±í•˜ë©´ ì‘ì„±í•œ ê¸€ì´ ë‹¤ì´ì–´ë¦¬ì— ë°”ë¡œ ì—…ë°ì´íŠ¸ê°€ ë˜ì–´ì•¼í•˜ëŠ”ë° ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ë•ŒëŠ” ê¸€ì„ ì‘ì„±í•˜ëŠ” postì‘ì—…ì„ í•œë’¤ getì‘ì—…ìœ¼ë¡œ ê²Œì‹œê¸€ì„ ë‹¤ì‹œ í˜¸ì¶œí•´ì•¼ í–ˆìŠµë‹ˆë‹¤.
ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì½”ë“œê°€ ì¡°ê¸ˆ ê¸¸ê³ , ë‹¤ì´ì–´ë¦¬ ê¸€ì„ ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•Šì•˜ëŠ”ë°ë„ ë¶ˆí•„ìš”í•œ ìš”ì²­ì„ í•˜ê²Œ ë˜ì–´ì„œ ì´ë¥¼ í•´ê²°í•˜ê³ ì ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ë‹¤ì´ì–´ë¦¬ í”„ë¡œì íŠ¸ì— ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ë¥¼ ì ì ˆí•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í–ˆê¸°ë•Œë¬¸ì— ì„œë²„ ìš”ì²­ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ staletimeê³¼ catchtimeì„ ì ì ˆí•˜ê²Œ ì„¤ì •í•´ì•¼í–ˆìŠµë‹ˆë‹¤. ì§„í–‰í•˜ëŠ” í”„ë¡œì íŠ¸ëŠ” ë°ì´í„° ë³€í™”ê°€ ìˆ˜ì‹œë¡œ ì¼ì–´ë‚˜ì§€ ì•Šê³  ì‚¬ìš©ìê°€ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ìˆ˜ì •í• ë•Œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ë°ì´í„° ë³€í™”ê°€ ë§ì§€ ì•Šì„ë•ŒëŠ” staletimeê³¼ catchtimeì„ ë¬´í•œëŒ€ë¡œ ì„¤ì •í•˜ê³ , ë°ì´í„°ì— ë³€í™”ê°€ ìƒê¸¸ë•Œ **queryClient.invalidateQueries() ** ë¥¼ ì„¤ì •í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™” ì‹œí‚¤ëŠ” ë°©ë²•ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.

## ğŸ§· ì‚¬ìš©í•œ í˜ì´ì§€

### useQuery - í™ˆ, ì¼ìƒê¸°ë¡ í˜ì´ì§€ì—ì„œ ì‚¬ìš©

- í™ˆ
  - ë‹¬ë ¥ì´ ì´ë™í• ë•Œë§ˆë‹¤ í•´ë‹¹ ì›”ì— ì“°ì¸ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜´
  - ë°ì´í„°ì˜ ë³€í™”ê°€ ì—†ëŠ”ë° ì›”ì„ ì´ë™í• ë•Œë§ˆë‹¤ ì„œë²„í˜¸ì¶œì„ í•œë‹¤ë©´ ë¹„íš¨ìœ¨ì ì´ë¼ê³  ìƒê°ì´ ë“¤ì–´ì„œ ì¼ê¸°ê°€ ì¶”ê°€ ëì„ ê²½ìš°ì—ë§Œ getì„ í•´ì˜¬ ìˆ˜ ìˆë„ë¡ useQuery ë¥¼ ì´ìš©
  - selectë¥¼ ì´ìš©í•´ì„œ dataë¥¼ ê°€ê³µ
  - refetchOnWindowFoucus ë‹¤ë¥¸ ì°½ìœ¼ë¡œ ì´ë™í–ˆë‹¤ê°€ ì™”ì„ë•Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šë„ë¡ í•¨
  - ì¼ê¸°ë¥¼ ì‘ì„±í• ë•Œ useMutation custom hook ìœ¼ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•¨ custom hookì¸ useRecordMutationì—ì„œ ì„œë²„ ìš”ì²­ì´ ì„±ê³µí•˜ë©´ í™ˆê³¼ ì¼ìƒ ê¸°ë¡ í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ get í•  ìˆ˜ ìˆë„ë¡ ì•„ë˜ì˜ ì½”ë“œë¥¼ ì‚¬ìš©

```tsx
queryClient.invalidateQueries(['record'], {
  refetchInactive: true,
});
```

```tsx
const { data, isLoading, isSuccess } = useQuery<LogType, AxiosError, GetDataType[]>(
  ['record', GetMonth],
  () => getRecord(GetMonth),
  {
    select: (record) => record.log,
    refetchOnWindowFocus: false,
    staleTime: Infinity,
    cacheTime: Infinity,
    onSuccess(data) {
      console.log(GetMonth);
      console.log(data);
    },
  },
);
```

- ì¼ìƒê¸°ë¡
  í˜ì´ì§€ê°€ ë³€í• ë•Œë§ˆë‹¤ í˜¸ì¶œì„í•˜ê³ , í™ˆì˜ í‚¤ì™€ ê°™ì€ 'record'ë¥¼ ì£¼ì–´ ì¼ê¸°ê°€ ì‘ì„±ë˜ë©´ refetchë˜ë„ë¡ ì½”ë“œë¥¼ êµ¬í˜„
  ì—…ë°ì´íŠ¸ ë˜ê¸°ì „ì— ì´ë¯¸ ì„œë²„ í˜¸ì¶œì„ í•œ í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ ì„œë²„ ìš”ì²­ì„ í•˜ì§€ ì•Šì•„ ë¶ˆí•„ìš”í•œ ìš”ì²­ì„ ì¤„ì„

```tsx
const { data, isLoading } = useQuery(['record', page], () => GetViewList(page), {
  staleTime: Infinity,
  cacheTime: Infinity,
  select: (record) => record.log,
  refetchOnWindowFocus: false,
  onSuccess(data) {
    console.log(data);
  },
  onError(err) {
    console.log(err);
  },
});
```

### useMutation - ì¼ê¸°ì‘ì„±, ì¼ê¸° ìˆ˜ì •

- ì¼ê¸°ì‘ì„±

```tsx
export default function useRecordMutation(
    key: string,
    setType: React.Dispatch<React.SetStateAction<string>>
) {
    const queryClient = useQueryClient();
    const [confirmModal, setConfirmModal] = useRecoilState(confirmState);
    return useMutation(key, (variable: PostDataType) => postRecord(variable), {
        onSuccess(data) {
            console.log(data);
            setConfirmModal(true);
            setType('confirm');
            queryClient.invalidateQueries(['record'], {
                refetchInactive: true,
            });
            toast.success('ê¸€ì‘ì„± ì™„ë£Œ');
        },
        onError(err) {
            console.log(err);
            setType('error');
            toast.error('â­•ï¸ ê¸€ì‘ì„± ì‹¤íŒ¨');
        },
    });
```

- useRecordMutation
  - formì˜ submitìœ¼ë¡œ ë°›ì•„ì§„ inputì˜ ë°ì´í„°ë“¤ì„ mustationí•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì¤€ë‹¤.
  - ì´ë¯¸ì§€ê°€ ì¡´ì¬í•œë‹¤ë©´ s3ì— ì €ì¥í•˜ëŠ” ì½”ë“œë„ í¬í•¨ë˜ì–´ìˆë‹¤. ì¼ê¸°ë¥¼ ì‘ì„±í•˜ëŠ”ë° ì“°ì´ëŠ” postí•¨ìˆ˜ê°€ ë„ˆë¬´ ê¸¸ì–´ì„œ useRecordMutationì´ë¼ëŠ” ì»¤ìŠ¤í…€ í›…ìœ¼ë¡œ ë§Œë“¤ê²Œ ë˜ì—ˆë‹¤.

```tsx
export default function useRecord() {
  let setDate = useSetRecoilState(curDateState);
  let [file, setFile] = useState<File>();
  useEffect(() => {
    setDate(new Date());
  }, []);

  let curDate = useRecoilValue(formatCurDay);
  let { mutate } = useRecordMutation('postRecord', setType);
  let onSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const user_id = 1;
    const datetime = curDate;
    const formData = new FormData(e.currentTarget);
    if (file instanceof File) {
      let { uploadFile } = s3upload(file);
      let url = await uploadFile();
      await formData.append('content_image', url);
    }
    const data = Object.fromEntries(formData);
    const { content_title, content_main, content_image, content_color } = data;
    const color = String(content_color).split('#')[1];

    if (content_title && content_main) {
      //post í˜¸ì¶œ
      mutate({
        user_id,
        datetime,
        content_title,
        content_main,
        content_image,
        color: color,
      });
    }
  };
  return { onSubmit, file, setFile, type };
}
```

## ê²°ê³¼

í™ˆí˜ì´ì§€ì—ì„œ ë‹¤ë¥¸í˜ì´ì§€ë¡œ ì´ë™í• ë•Œ ì¼ê¸°ê°€ ì‘ì„±ë˜ê±°ë‚˜ ìˆ˜ì •ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë°ì´í„° ìš”ì²­ì„ í•˜ì§€ ì•Šê²Œ ë˜ì—ˆê³ , ì¼ê¸°ê°€ ì‘ì„±ë˜ê±°ë‚˜ ìˆ˜ì •ëì„ë•Œ postì™€ ë™ì‹œì— getìš”ì²­ì„ í•˜ê²Œ ë˜ì–´ ì¼ê¸°ê°€ ë°”ë¡œ ì—…ë°ì´íŠ¸ ë˜ë„ë¡ êµ¬í˜„ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
